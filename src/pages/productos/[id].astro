---
import Layout from "../../layouts/Layout.astro";
import { getProductById } from "../../services/product.service";
import { Icon } from "astro-icon/components";
import styles from "./styles/[id].module.css";

const { id } = Astro.params;

if (!id) {
    return Astro.redirect("/404");
}

const product = await getProductById(id);

if (!product) {
    return Astro.redirect("/404");
}

const hasDiscount = product.precioConDescuento !== null;
---

<Layout title={`${product.nombre} | MarketFlex`}>
    <div class={styles.container}>
        <script
            type="application/json"
            id="product-data"
            set:html={JSON.stringify(product)}
        />
        <nav class={styles.breadcrumb} aria-label="Breadcrumb">
            <a href="/">Inicio</a>
            <Icon
                name="lucide:chevron-right"
                size={14}
                class={styles.breadcrumbIcon}
            />
            <a href={`/search?type=${product.categoria}`}>{product.categoria}</a
            >
            {
                product.subcategoria && (
                    <>
                        <Icon
                            name="lucide:chevron-right"
                            size={14}
                            class={styles.breadcrumbIcon}
                        />
                        <a href={`/search?category=${product.subcategoria}`}>
                            {product.subcategoria}
                        </a>
                    </>
                )
            }
            <Icon
                name="lucide:chevron-right"
                size={14}
                class={styles.breadcrumbIcon}
            />
            <span>{product.nombre}</span>
        </nav>

        <div class={styles.productGrid}>
            <div class={styles.imageSection}>
                <div class={styles.imageWrapper}>
                    <img
                        src={product.foto
                            ? `http://localhost:5979/${product.foto}`
                            : "/placeholder.png"}
                        alt={product.nombre}
                        class={styles.mainImage}
                    />
                    {
                        product.envioGratis && (
                            <div class={styles.freeShippingBadge}>
                                <Icon name="lucide:truck" size={16} /> Envío
                                Gratis
                            </div>
                        )
                    }
                </div>
            </div>

            <div class={styles.infoSection}>
                <div class={styles.header}>
                    <div class={styles.brandContainer}>
                        {
                            product.marca && (
                                <span class={styles.brand}>
                                    {product.marca}
                                </span>
                            )
                        }
                        {
                            product.autor && (
                                <span class={styles.author}>
                                    {product.autor}
                                </span>
                            )
                        }
                    </div>
                    <h1 class={styles.title}>{product.nombre}</h1>
                </div>

                <div class={styles.priceContainer}>
                    {
                        hasDiscount ? (
                            <div class={styles.priceRow}>
                                <span class={styles.discountPrice}>
                                    ${product.precioConDescuento}
                                </span>
                                <span class={styles.originalPrice}>
                                    ${product.precioActual}
                                </span>
                                {product.descuentoActivo?.porcentaje && (
                                    <span class={styles.discountBadge}>
                                        -{product.descuentoActivo.porcentaje}%
                                        OFF
                                    </span>
                                )}
                            </div>
                        ) : (
                            <span class={styles.mainPrice}>
                                ${product.precioActual}
                            </span>
                        )
                    }

                    {
                        product.promocionActiva && (
                            <div class={styles.promoLabel}>
                                <Icon name="lucide:tag" size={16} />
                                <span>{product.promocionActiva.nombre}</span>
                            </div>
                        )
                    }
                </div>

                <div class={styles.stockStatus}>
                    {
                        product.stock > 0 ? (
                            <span class={styles.inStock}>
                                <Icon name="lucide:check-circle" size={18} />
                                Stock disponible ({product.stock} unidades)
                            </span>
                        ) : (
                            <span class={styles.outOfStock}>
                                <Icon name="lucide:alert-circle" size={18} />
                                Sin stock por el momento
                            </span>
                        )
                    }
                </div>

                <div class={styles.actions}>
                    <div class={styles.quantityWrapper}>
                        <button
                            class={styles.quantityBtn}
                            id="decrement-qty"
                            aria-label="Disminuir cantidad"
                            disabled={product.stock === 0}
                        >
                            <Icon name="lucide:minus" size={18} />
                        </button>
                        <span class={styles.quantityValue} id="quantity-display"
                            >1</span
                        >
                        <button
                            class={styles.quantityBtn}
                            id="increment-qty"
                            aria-label="Aumentar cantidad"
                            disabled={product.stock === 0}
                        >
                            <Icon name="lucide:plus" size={18} />
                        </button>
                    </div>

                    <button
                        class={styles.addToCart}
                        id="add-to-cart-btn"
                        disabled={product.stock === 0}
                    >
                        <Icon name="lucide:shopping-cart" size={20} />
                        Agregar al carrito
                    </button>
                </div>

                <div class={styles.trustBadges}>
                    <div class={styles.trustItem}>
                        <Icon name="lucide:shield-check" size={20} />
                        <span>Compra Protegida</span>
                    </div>
                    <div class={styles.trustItem}>
                        <Icon name="lucide:rotate-ccw" size={20} />
                        <span>Devolución Gratis</span>
                    </div>
                </div>
            </div>
        </div>

        <div class={styles.detailsGrid}>
            <div class={styles.descriptionCard}>
                <h2>Descripción</h2>
                <div class={styles.descriptionContent}>
                    {
                        product.descripcion ||
                            "No hay descripción disponible para este producto."
                    }
                </div>
            </div>

            <div class={styles.specsCard}>
                <h2>Especificaciones</h2>
                <table class={styles.specsTable}>
                    <tbody>
                        {
                            product.caracteristicas.map((char) => (
                                <tr>
                                    <td>{char.nombre}</td>
                                    <td>{char.valor}</td>
                                </tr>
                            ))
                        }
                        {
                            product.marca && (
                                <tr>
                                    <td>Marca / Editorial</td>
                                    <td>{product.marca}</td>
                                </tr>
                            )
                        }
                        <tr>
                            <td>Categoría</td>
                            <td>{product.categoria}</td>
                        </tr>
                        {
                            product.subcategoria && (
                                <tr>
                                    <td>Subcategoría</td>
                                    <td>{product.subcategoria}</td>
                                </tr>
                            )
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</Layout>

<script>
    import { addItem } from "../../store/cartStore";
    import type { Product } from "../../types/product.types";

    // Get the product data from the server-side to the client-side
    const productData = document.getElementById("product-data")?.textContent;
    const product: Product | null = productData
        ? JSON.parse(productData)
        : null;

    const addBtn = document.getElementById("add-to-cart-btn");
    const quantityDisplay = document.getElementById("quantity-display");
    const incrementBtn = document.getElementById("increment-qty");
    const decrementBtn = document.getElementById("decrement-qty");

    let quantity = 1;

    function updateDisplay() {
        if (quantityDisplay) quantityDisplay.textContent = quantity.toString();
        if (decrementBtn) {
            (decrementBtn as HTMLButtonElement).disabled = quantity <= 1;
        }
    }

    incrementBtn?.addEventListener("click", () => {
        if (product && quantity < product.stock) {
            quantity++;
            updateDisplay();
        }
    });

    decrementBtn?.addEventListener("click", () => {
        if (quantity > 1) {
            quantity--;
            updateDisplay();
        }
    });

    function handleAddToCart() {
        if (!product) return;

        const token = localStorage.getItem("marketflex_token");
        if (!token) {
            window.location.href = "/login";
            return;
        }

        // Add to cart store
        addItem(product, quantity);

        // Notify user with premium message
        // @ts-ignore - Sileo is injected globally
        if (window.triggerSileo) {
            const message =
                quantity === 1
                    ? `¡Hecho! Agregaste 1 unidad de "${product.nombre}" al carrito.`
                    : `¡Excelente! Agregaste ${quantity} unidades de "${product.nombre}" a tu bolsa.`;

            // @ts-ignore
            window.triggerSileo("success", message);
        }
    }

    addBtn?.addEventListener("click", handleAddToCart);
</script>
