---
import Layout from "../layouts/Layout.astro";
import Notifications from "../components/common/Notifications";
import FeaturedProducts from "../components/products/FeaturedProducts.astro";
import ProductCarousel from "../components/products/ProductCarousel.astro";
import {
	getFeaturedProducts,
	getNewArrivals,
	getBestsellers,
	getOffers,
} from "../services/product.service";
import styles from "./styles/index.module.css";

const products = await getFeaturedProducts();
const { data: newArrivals } = await getNewArrivals(1, 7);
const { data: bestSellers } = await getBestsellers(1, 10);
const { data: allOffers } = await getOffers(1, 20);
const offers = allOffers
	.filter((p) => p.descuentoActivo?.porcentaje !== null)
	.slice(0, 7);
const user = Astro.url.searchParams.get("user") || "Usuario";
const isNewUser = Astro.url.searchParams.get("new") === "true";
const welcomeMessage = isNewUser
	? `¡Bienvenido, ${user}!`
	: `Bienvenido de nuevo, ${user}`;
---

<Layout title="MarketFlex | Premium Marketplace" showToaster={false}>
	<Notifications
		client:only="react"
		message={welcomeMessage}
		type="success"
		delay={200}
		position="top-center"
		requiredQueryParam="login_success"
	/>

	<FeaturedProducts products={products} />

	<ProductCarousel
		id="best-sellers"
		title="Más"
		titleHighlight="vendidos"
		icon="lucide:trending-up"
		products={bestSellers}
		limit={10}
		showViewMore={false}
		showRank={true}
	/>

	<ProductCarousel
		id="offers"
		title="Grandes"
		titleHighlight="Ofertas"
		icon="lucide:tag"
		products={offers}
		limit={7}
		showViewMore={true}
		viewMoreHref="/offers"
	/>

	<ProductCarousel
		id="new-arrivals"
		title="Últimas"
		titleHighlight="Novedades"
		icon="lucide:sparkles"
		products={newArrivals}
		limit={7}
		viewMoreHref="/new-arrivals"
	/>
</Layout>
