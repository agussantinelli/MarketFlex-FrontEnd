---
export const prerender = false;
import Layout from "../layouts/Layout.astro";
import { Icon } from "astro-icon/components";
import ProductCard from "../components/products/ProductCard.astro";
import ProductControls from "../components/products/ProductControls.astro";
import ActiveFilters from "../components/products/ActiveFilters.astro";
import { getOffers } from "../services/product.service";
import styles from "./styles/search.module.css";

const currentPage = parseInt(Astro.url.searchParams.get("page") || "1");
const sort = Astro.url.searchParams.get("sort") || "relevance";
const minPriceParam = Astro.url.searchParams.get("minPrice") || "";
const maxPriceParam = Astro.url.searchParams.get("maxPrice") || "";
const withStockRaw = Astro.url.searchParams.get("withStock");
const withStockParam = withStockRaw !== "false";
const hasWithStockFilter = withStockRaw !== null;
const promotionParam = Astro.url.searchParams.get("promotion") || "";
const limit = 20;

const response = await getOffers(currentPage, limit, sort, minPriceParam, maxPriceParam, withStockParam.toString(), promotionParam);

const products = response.data;
const pagination = response.pagination;

// Helper to build pagination links
const getPageUrl = (page: number) => {
    const params = new URLSearchParams(Astro.url.searchParams);
    params.set("page", page.toString());
    return `/offers?${params.toString()}`;
};

const startRange = (currentPage - 1) * limit + 1;
const endRange = Math.min(currentPage * limit, pagination.total);
---

<Layout title="MarketFlex | Grandes Ofertas y Promociones">
    <section class={styles.searchSection}>
        <div class={styles.searchHeader}>
            <h2 class={styles.sectionTitle}>
                Grandes <span class="gradient-text">Ofertas</span>
                <span class={styles.resultCount}>
                    ({pagination.total})
                </span>
            </h2>

            <div class={styles.controlsWrapper}>
                <ProductControls 
                    sort={sort}
                    baseUrl="/offers"
                    params={Astro.url.searchParams}
                    showOnlyOffersFilter={false}
                    showPromotions={true}
                />

                <ActiveFilters 
                    baseUrl="/offers"
                    params={Astro.url.searchParams}
                />
            </div>
        </div>

        {
            products.length > 0 ? (
                <>
                    <div class={styles.productsGrid} id="products-grid">
                        {products.map((product) => (
                            <ProductCard
                                product={product}
                                showFeatured={false}
                            />
                        ))}
                    </div>

                    {pagination.totalPages > 1 && (
                        <nav
                            class={styles.pagination}
                            aria-label="Navegación de páginas"
                        >
                            <div class={styles.paginationControls}>
                                <a
                                    href={getPageUrl(currentPage - 1)}
                                    class={`${styles.paginationItem} ${styles.prev} ${currentPage === 1 ? styles.disabled : ""}`}
                                    aria-label="Página anterior"
                                >
                                    <Icon name="lucide:chevron-left" />
                                    <span>Anterior</span>
                                </a>

                                <a
                                    href={getPageUrl(currentPage + 1)}
                                    class={`${styles.paginationItem} ${styles.next} ${currentPage === pagination.totalPages ? styles.disabled : ""}`}
                                    aria-label="Página siguiente"
                                >
                                    <span>Siguiente</span>
                                    <Icon name="lucide:chevron-right" />
                                </a>
                            </div>

                            <div class={styles.paginationPages}>
                                {Array.from(
                                    { length: pagination.totalPages },
                                    (_, i) => (
                                        <a
                                            href={getPageUrl(i + 1)}
                                            class={`${styles.paginationItem} ${styles.page} ${currentPage === i + 1 ? styles.active : ""}`}
                                            aria-label={`Ir a página ${i + 1}`}
                                        >
                                            {i + 1}
                                        </a>
                                    ),
                                )}
                            </div>
                        </nav>
                        <div class={styles.paginationInfo}>
                            Página <strong>{currentPage}</strong> de{" "}
                            <strong>{pagination.totalPages}</strong>, viendo los
                            publicaciones <strong>{startRange}-{endRange}</strong> de{" "}
                            <strong>{pagination.total}</strong>
                        </div>
                    )}
                </>
            ) : (
                <div class={styles.emptyResults}>
                    <div class={styles.emptyIconWrapper}>
                        <Icon name="lucide:tag" class={styles.emptyIcon} />
                    </div>
                    <h3 class={styles.emptyTitle}>No hay ofertas activas</h3>
                    <p>
                        Parece que no hay productos con descuento en este momento.
                        <br />
                        ¡Volvé pronto para ver nuestras promociones!
                    </p>
                    <div class={styles.actions}>
                        <a href="/" class="btn btn-secondary btn-sm">
                            Volver al Inicio
                        </a>
                        <a href="/search" class="btn btn-primary btn-sm">
                            Ver Todo el Catálogo
                        </a>
                    </div>
                </div>
            )
        }
    </section>
</Layout>
