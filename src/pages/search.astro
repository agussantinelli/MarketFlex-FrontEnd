---
export const prerender = false;
import Layout from "../layouts/Layout.astro";
import { Icon } from "astro-icon/components";
import ProductCard from "../components/products/ProductCard.astro";
import ProductControls from "../components/products/ProductControls.astro";
import ActiveFilters from "../components/products/ActiveFilters.astro";
import { searchProducts } from "../services/product.service";
import styles from "./styles/search.module.css";

const searchQuery = Astro.url.searchParams.get("q")?.trim() || "";
const sort = Astro.url.searchParams.get("sort") || "";
const typeParam = Astro.url.searchParams.get("type") || "";
const categoryParam = Astro.url.searchParams.get("category") || "";
const offersParam = Astro.url.searchParams.get("offers") || "";
const minPriceParam = Astro.url.searchParams.get("minPrice") || "";
const maxPriceParam = Astro.url.searchParams.get("maxPrice") || "";
const onlyOffersParam = Astro.url.searchParams.get("onlyOffers") === "true";
const withStockRaw = Astro.url.searchParams.get("withStock");
const withStockParam = withStockRaw !== "false";
const hasWithStockFilter = withStockRaw !== null;
const exploreParam = Astro.url.searchParams.get("explore") === "true";
const brandParam = Astro.url.searchParams.get("brand") || "";

const fixedKeys: string[] = [];
if (!exploreParam && !searchQuery) {
    if (typeParam) fixedKeys.push("type");
    if (categoryParam) fixedKeys.push("category");
}

const currentPage = parseInt(Astro.url.searchParams.get("page") || "1");
const limit = 20;

const response = await searchProducts({
    query: searchQuery,
    sort,
    type: typeParam,
    category: categoryParam,
    offers: offersParam,
    minPrice: minPriceParam,
    maxPrice: maxPriceParam,
    withStock: withStockParam.toString(),
    onlyOffers: onlyOffersParam ? "true" : undefined,
    brand: brandParam,
    page: currentPage,
    limit,
});

const products = response.data;
const pagination = response.pagination;

// Helper to build pagination links
const getPageUrl = (page: number) => {
    const params = new URLSearchParams(Astro.url.searchParams);
    params.set("page", page.toString());
    return `/search?${params.toString()}`;
};

const startRange = (currentPage - 1) * limit + 1;
const endRange = Math.min(currentPage * limit, pagination.total);
---

<Layout
    title={`MarketFlex | ${searchQuery ? `Resultados: ${searchQuery}` : "Explorar Productos"}`}
>
    <section class={styles.searchSection}>
        <div class={styles.searchHeader}>
            <h2 class={styles.sectionTitle}>
                {
                    searchQuery ? (
                        <>
                            Resultados para "
                            <span class="gradient-text">{searchQuery}</span>"
                            <span class={styles.resultCount}>
                                ({pagination.total})
                            </span>
                        </>
                    ) : (
                        <>
                            Explorando{" "}
                            <span class="gradient-text">Productos</span>
                            <span class={styles.resultCount}>
                                ({pagination.total})
                            </span>
                        </>
                    )
                }
            </h2>

            {
                (products.length > 0 || !searchQuery) && (
                    <div class={styles.controlsWrapper}>
                        <ProductControls 
                            sort={sort}
                            baseUrl="/search"
                            params={Astro.url.searchParams}
                            fixedKeys={fixedKeys}
                            showPromotions={exploreParam}
                        />
                        
                        <ActiveFilters 
                            baseUrl="/search"
                            params={Astro.url.searchParams}
                            fixedKeys={fixedKeys}
                        />
                    </div>
                )
            }
        </div>





        {
            products.length > 0 ? (
                <>
                    <div class={styles.productsGrid} id="products-grid">
                        {products.map((product) => (
                            <ProductCard
                                product={product}
                                showFeatured={false}
                            />
                        ))}
                    </div>

                    {pagination.totalPages > 1 && (
                        <nav
                            class={styles.pagination}
                            aria-label="Navegación de páginas"
                        >
                            <div class={styles.paginationControls}>
                                <a
                                    href={getPageUrl(currentPage - 1)}
                                    class={`${styles.paginationItem} ${styles.prev} ${currentPage === 1 ? styles.disabled : ""}`}
                                    aria-label="Página anterior"
                                >
                                    <Icon name="lucide:chevron-left" />
                                    <span>Anterior</span>
                                </a>

                                <a
                                    href={getPageUrl(currentPage + 1)}
                                    class={`${styles.paginationItem} ${styles.next} ${currentPage === pagination.totalPages ? styles.disabled : ""}`}
                                    aria-label="Página siguiente"
                                >
                                    <span>Siguiente</span>
                                    <Icon name="lucide:chevron-right" />
                                </a>
                            </div>

                            <div class={styles.paginationPages}>
                                {Array.from(
                                    { length: pagination.totalPages },
                                    (_, i) => (
                                        <a
                                            href={getPageUrl(i + 1)}
                                            class={`${styles.paginationItem} ${styles.page} ${currentPage === i + 1 ? styles.active : ""}`}
                                            aria-label={`Ir a página ${i + 1}`}
                                        >
                                            {i + 1}
                                        </a>
                                    ),
                                )}
                            </div>
                        </nav>
                        <div class={styles.paginationInfo}>
                            Página <strong>{currentPage}</strong> de{" "}
                            <strong>{pagination.totalPages}</strong>, viendo los
                            productos <strong>{startRange}-{endRange}</strong> de{" "}
                            <strong>{pagination.total}</strong>
                        </div>
                    )}
                </>
            ) : (
                <div class={styles.emptyResults}>
                    <div class={styles.emptyIconWrapper}>
                        <Icon name="lucide:search-x" class={styles.emptyIcon} />
                    </div>
                    <h3 class={styles.emptyTitle}>
                        {searchQuery ? "Sin resultados" : "Catálogo vacío"}
                    </h3>
                    <p>
                        {searchQuery ? (
                            <>
                                No encontramos productos que coincidan con "
                                <strong>{searchQuery}</strong>".
                                <br />
                                Intentá con otras palabras clave.
                            </>
                        ) : (
                            "No hay productos disponibles en este momento."
                        )}
                    </p>
                    <div class={styles.actions}>
                        <a href="/" class="btn btn-secondary btn-sm">
                            Volver al Inicio
                        </a>
                        {searchQuery && (
                            <a href="/search" class="btn btn-primary btn-sm">
                                Ver Todos los Productos
                            </a>
                        )}
                    </div>
                </div>
            )
        }
    </section>
</Layout>
