---
import { Icon } from "astro-icon/components";
import { getCategories } from "../services/category.service";
import { getSubcategories } from "../services/subcategory.service";
import UserDropdown from "../components/shared/UserDropdown.astro";
import styles from "./styles/Navbar.module.css";

const categories = await getCategories();
const subcategories = await getSubcategories();
---

<nav class={styles.navbar}>
    <div class={styles.navContainer}>
        <a href="/" class={`${styles.navLogo} nav-logo`}>
            <img
                src="/logo-marketflex-letters.png"
                alt="MarketFlex Logo"
                class={styles.logoImg}
                width="40"
                height="40"
            />
            <span class={styles.logoText}>MarketFlex</span>
        </a>

        <form
            action="/search"
            method="GET"
            class={`${styles.navSearchForm} nav-search-form`}
        >
            <div class={styles.searchInputWrapper}>
                <Icon name="lucide:search" class={styles.searchIcon} />
                <input
                    type="text"
                    name="q"
                    placeholder="Buscar productos..."
                    class={`${styles.searchInput} search-input`}
                    autocomplete="off"
                />
                <button
                    type="button"
                    class={`${styles.searchClearBtn} search-clear-btn`}
                    aria-label="Clear search"
                >
                    <Icon name="lucide:x" class={styles.clearIcon} />
                </button>
            </div>
        </form>

        <a
            href="/cart"
            class={`${styles.mobileCartLink} mobile-cart-link`}
            aria-label="Ver carrito de compras"
        >
            <Icon
                name="lucide:shopping-cart"
                class={styles.cartIcon}
                aria-hidden="true"
            />
            <span class={`${styles.cartBadge} cart-count`} aria-hidden="true"
                >0</span
            >
        </a>

        <button
            class={`${styles.mobileMenuBtn} mobile-menu-btn`}
            aria-label="Toggle mobile menu"
            aria-expanded="false"
        >
            <Icon
                name="lucide:menu"
                class={styles.iconMenu}
                aria-hidden="true"
            />
            <Icon name="lucide:x" class={styles.iconClose} aria-hidden="true" />
        </button>

        <div class={`${styles.navLinks} nav-links`}>
            <!-- Explorar -->
            <a href="/search?explore=true" class={styles.navLink}>
                <Icon name="lucide:compass" class={styles.linkIcon} />
                Explorar
            </a>

            <!-- Categorías Dropdown Hierárquico -->
            <div class={`${styles.navItemDropdown} nav-item-dropdown`}>
                <button
                    class={`${styles.navLink} ${styles.dropdownBtn} dropdown-btn`}
                >
                    <Icon name="lucide:book" class={styles.linkIcon} />
                    Categorías
                    <Icon
                        name="lucide:chevron-down"
                        class={styles.chevronIcon}
                    />
                </button>
                <div class={`${styles.navDropdownMenu} nav-dropdown-menu`}>
                    {
                        categories.map((cat) => {
                            const catSubcategories = subcategories.filter(
                                (s) => s.categoriaId === cat.id,
                            );
                            const hasSubcategories =
                                catSubcategories.length > 0;

                            return (
                                <div
                                    class={`${styles.categoryItem} category-item`}
                                >
                                    <div class={styles.categoryHeader}>
                                        <a
                                            href={`/search?type=${cat.nombre}`}
                                            class={styles.categoryName}
                                        >
                                            {cat.nombre}
                                        </a>
                                        {hasSubcategories && (
                                            <button
                                                class={`${styles.subcatToggle} subcat-toggle`}
                                                aria-label={`Ver subcategorías de ${cat.nombre}`}
                                            >
                                                <Icon
                                                    name="lucide:chevron-right"
                                                    class={styles.subcatIcon}
                                                />
                                            </button>
                                        )}
                                    </div>
                                    {hasSubcategories && (
                                        <div
                                            class={`${styles.subcategoryMenu} subcategory-menu`}
                                        >
                                            {catSubcategories.map((sub) => (
                                                <a
                                                    href={`/search?type=${cat.nombre}&category=${sub.nombre}`}
                                                    class={
                                                        styles.subcategoryLink
                                                    }
                                                >
                                                    {sub.nombre}
                                                </a>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            );
                        })
                    }
                </div>
            </div>

            <!-- Ofertas -->
            <a href="/offers" class={styles.navLink}>
                <Icon name="lucide:tag" class={styles.linkIcon} />
                Ofertas
            </a>

            <!-- Novedades -->
            <a href="/new-arrivals" class={styles.navLink}>
                <Icon name="lucide:sparkles" class={styles.linkIcon} />
                Novedades
            </a>

            <!-- Auth Section -->
            <div class="nav-auth-guest">
                <a href="/login" class="btn btn-primary btn-sm">
                    <Icon name="lucide:user" class={styles.btnIcon} />
                    Ingresar
                </a>
            </div>

            <div class="nav-auth-user" style="display: none;">
                <a
                    href="/cart"
                    class={styles.cartLink}
                    aria-label="Carrito de compras"
                >
                    <Icon name="lucide:shopping-cart" class={styles.cartIcon} />
                    <span class={`${styles.cartBadge} cart-count`}>0</span>
                </a>
                <UserDropdown />
            </div>
        </div>
    </div>
</nav>

<script>
    import { initNavbar } from "../scripts/navbar";
    import styles from "./styles/Navbar.module.css";
    // We import modalStyles globally or locally if needed for confirmation modal

    // Initialize on load
    initNavbar(styles);

    // Support for View Transitions
    document.addEventListener("astro:page-load", () => initNavbar(styles));
</script>
