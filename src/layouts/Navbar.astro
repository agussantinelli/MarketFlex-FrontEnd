---
import { Icon } from "astro-icon/components";
import { getCategories } from "../services/category.service";
import { getSubcategories } from "../services/subcategory.service";
import ConfirmationModal from "../components/common/ConfirmationModal.astro";
import styles from "./styles/Navbar.module.css";
import modalStyles from "../components/common/styles/ConfirmationModal.module.css";

const categories = await getCategories();
const subcategories = await getSubcategories();
---

<nav class={styles.navbar}>
    <div class={styles.navContainer}>
        <a href="/" class={`${styles.navLogo} nav-logo`}>
            <img
                src="/logo-marketflex-letters.png"
                alt="MarketFlex Logo"
                class={styles.logoImg}
            />
            <span class={styles.logoText}>MarketFlex</span>
        </a>

        <form
            action="/search"
            method="GET"
            class={`${styles.navSearchForm} nav-search-form`}
        >
            <div class={styles.searchInputWrapper}>
                <Icon name="lucide:search" class={styles.searchIcon} />
                <input
                    type="text"
                    name="q"
                    placeholder="Buscar productos..."
                    class={`${styles.searchInput} search-input`}
                    autocomplete="off"
                />
                <button
                    type="button"
                    class={`${styles.searchClearBtn} search-clear-btn`}
                    aria-label="Clear search"
                >
                    <Icon name="lucide:x" class={styles.clearIcon} />
                </button>
            </div>
        </form>

        <button
            class={`${styles.mobileMenuBtn} mobile-menu-btn`}
            aria-label="Toggle menu"
        >
            <Icon name="lucide:menu" class={styles.iconMenu} />
            <Icon name="lucide:x" class={styles.iconClose} />
        </button>

        <div class={`${styles.navLinks} nav-links`}>
            <!-- Explorar -->
            <a href="/search" class={styles.navLink}>
                <Icon name="lucide:compass" class={styles.linkIcon} />
                Explorar
            </a>

            <!-- Categorías Dropdown Hierárquico -->
            <div class={`${styles.navItemDropdown} nav-item-dropdown`}>
                <button
                    class={`${styles.navLink} ${styles.dropdownBtn} dropdown-btn`}
                >
                    <Icon name="lucide:book" class={styles.linkIcon} />
                    Categorías
                    <Icon
                        name="lucide:chevron-down"
                        class={styles.chevronIcon}
                    />
                </button>
                <div class={`${styles.navDropdownMenu} nav-dropdown-menu`}>
                    {
                        categories.map((cat) => {
                            const catSubcategories = subcategories.filter(
                                (s) => s.categoriaId === cat.id,
                            );
                            const hasSubcategories =
                                catSubcategories.length > 0;

                            return (
                                <div
                                    class={`${styles.categoryItem} category-item`}
                                >
                                    <div class={styles.categoryHeader}>
                                        <a
                                            href={`/search?type=${cat.nombre}`}
                                            class={styles.categoryName}
                                        >
                                            {cat.nombre}
                                        </a>
                                        {hasSubcategories && (
                                            <button
                                                class={`${styles.subcatToggle} subcat-toggle`}
                                                aria-label={`Ver subcategorías de ${cat.nombre}`}
                                            >
                                                <Icon
                                                    name="lucide:chevron-right"
                                                    class={styles.subcatIcon}
                                                />
                                            </button>
                                        )}
                                    </div>
                                    {hasSubcategories && (
                                        <div
                                            class={`${styles.subcategoryMenu} subcategory-menu`}
                                        >
                                            {catSubcategories.map((sub) => (
                                                <a
                                                    href={`/search?type=${cat.nombre}&category=${sub.nombre}`}
                                                    class={
                                                        styles.subcategoryLink
                                                    }
                                                >
                                                    {sub.nombre}
                                                </a>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            );
                        })
                    }
                </div>
            </div>

            <!-- Ofertas -->
            <a href="/search?offers=true" class={styles.navLink}>
                <Icon name="lucide:tag" class={styles.linkIcon} />
                Ofertas
            </a>

            <!-- Novedades -->
            <a href="/search?newArrivals=true" class={styles.navLink}>
                <Icon name="lucide:sparkles" class={styles.linkIcon} />
                Novedades
            </a>

            <!-- Auth Section -->
            <div class="nav-auth-guest">
                <a href="/login" class="btn btn-primary btn-sm">
                    <Icon name="lucide:user" class={styles.btnIcon} />
                    Ingresar
                </a>
            </div>

            <div class="nav-auth-user" style="display: none;">
                <a
                    href="/cart"
                    class={styles.cartLink}
                    aria-label="Carrito de compras"
                >
                    <Icon name="lucide:shopping-cart" class={styles.cartIcon} />
                    <span class={`${styles.cartBadge} cart-count`}>0</span>
                </a>
                <div class={`${styles.userDropdown} user-dropdown`}>
                    <button
                        class={`${styles.dropdownTrigger} dropdown-trigger`}
                    >
                        <span class={styles.userGreeting}
                            >Hola, <span id="user-name">Usuario</span></span
                        >
                        <Icon
                            name="lucide:chevron-down"
                            class={styles.dropdownIcon}
                        />
                    </button>
                    <div class={`${styles.dropdownMenu} dropdown-menu`}>
                        <a href="/profile" class={styles.dropdownItem}>
                            <Icon name="lucide:user" class={styles.itemIcon} />
                            Mi Perfil
                        </a>
                        <a
                            href="/admin/dashboard"
                            class={`${styles.dropdownItem} admin-only`}
                            style="display: none;"
                        >
                            <Icon
                                name="lucide:layout-dashboard"
                                class={styles.itemIcon}
                            />
                            Panel Admin
                        </a>
                        <a
                            href="/orders"
                            class={`${styles.dropdownItem} customer-only`}
                        >
                            <Icon
                                name="lucide:shopping-bag"
                                class={styles.itemIcon}
                            />
                            Mis Compras
                        </a>
                        <div class={styles.dropdownDivider}></div>
                        <button
                            id="logout-btn"
                            class={`${styles.dropdownItem} ${styles.textRed}`}
                        >
                            <Icon
                                name="lucide:log-out"
                                class={styles.itemIcon}
                            />
                            Cerrar Sesión
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <ConfirmationModal
        id="navbar-logout-modal"
        title="¿Cerrar sesión?"
        message="¿Estás seguro que deseas cerrar tu sesión actual? Tendrás que volver a ingresar tus credenciales para acceder de nuevo."
        confirmText="Cerrar Sesión"
        cancelText="Cancelar"
        type="danger"
    />
</nav>

<script>
    import { initNavbar } from "../scripts/navbar";
    import styles from "./styles/Navbar.module.css";
    import modalStyles from "../components/common/styles/ConfirmationModal.module.css";

    // Initialize on load
    initNavbar(styles, modalStyles);

    // Support for View Transitions
    document.addEventListener("astro:page-load", () =>
        initNavbar(styles, modalStyles),
    );
</script>
