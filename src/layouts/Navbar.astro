---
import { Icon } from "astro-icon/components";
import { getProductTypes } from "../services/product-type.service";
import { getCategories } from "../services/category.service";
import styles from "./styles/Navbar.module.css";

const productTypes = await getProductTypes();
const categories = await getCategories();
---

<nav class={styles.navbar}>
    <div class={styles.navContainer}>
        <a href="/" class={`${styles.navLogo} nav-logo`}>
            <img
                src="/logo-marketflex-letters.png"
                alt="MarketFlex Logo"
                class={styles.logoImg}
            />
            <span class={styles.logoText}>MarketFlex</span>
        </a>

        <form
            action="/search"
            method="GET"
            class={`${styles.navSearchForm} nav-search-form`}
        >
            <div class={styles.searchInputWrapper}>
                <Icon name="lucide:search" class={styles.searchIcon} />
                <input
                    type="text"
                    name="q"
                    placeholder="Buscar productos..."
                    class={`${styles.searchInput} search-input`}
                    autocomplete="off"
                />
                <button
                    type="button"
                    class={`${styles.searchClearBtn} search-clear-btn`}
                    aria-label="Clear search"
                >
                    <Icon name="lucide:x" class={styles.clearIcon} />
                </button>
            </div>
        </form>

        <button
            class={`${styles.mobileMenuBtn} mobile-menu-btn`}
            aria-label="Toggle menu"
        >
            <Icon name="lucide:menu" class={styles.iconMenu} />
            <Icon name="lucide:x" class={styles.iconClose} />
        </button>

        <div class={`${styles.navLinks} nav-links`}>
            <!-- Explorar -->
            <a href="/search" class={styles.navLink}>
                <Icon name="lucide:compass" class={styles.linkIcon} />
                Explorar
            </a>

            <!-- Tipos Dropdown -->
            <div class={`${styles.navItemDropdown} nav-item-dropdown`}>
                <button
                    class={`${styles.navLink} ${styles.dropdownBtn} dropdown-btn`}
                >
                    <Icon name="lucide:book" class={styles.linkIcon} />
                    Tipos
                    <Icon
                        name="lucide:chevron-down"
                        class={styles.chevronIcon}
                    />
                </button>
                <div class={styles.navDropdownMenu}>
                    {
                        productTypes.map((type) => (
                            <a
                                href={`/search?type=${type.nombre}`}
                                class={styles.dropdownLink}
                            >
                                {type.nombre}
                            </a>
                        ))
                    }
                </div>
            </div>

            <!-- Categorías Dropdown -->
            <div class={`${styles.navItemDropdown} nav-item-dropdown`}>
                <button
                    class={`${styles.navLink} ${styles.dropdownBtn} dropdown-btn`}
                >
                    <Icon name="lucide:layers" class={styles.linkIcon} />
                    Categorías
                    <Icon
                        name="lucide:chevron-down"
                        class={styles.chevronIcon}
                    />
                </button>
                <div class={styles.navDropdownMenu}>
                    {
                        categories.map((cat) => (
                            <a
                                href={`/search?category=${cat.nombre}`}
                                class={styles.dropdownLink}
                            >
                                {cat.nombre}
                            </a>
                        ))
                    }
                </div>
            </div>

            <!-- Ofertas -->
            <a href="/search?offers=true" class={styles.navLink}>
                <Icon name="lucide:tag" class={styles.linkIcon} />
                Ofertas
            </a>

            <!-- Auth Section -->
            <div class="nav-auth-guest">
                <a href="/login" class="btn btn-primary btn-sm">
                    <Icon name="lucide:user" class={styles.btnIcon} />
                    Ingresar
                </a>
            </div>

            <div class="nav-auth-user" style="display: none;">
                <div class={`${styles.userDropdown} user-dropdown`}>
                    <button
                        class={`${styles.dropdownTrigger} dropdown-trigger`}
                    >
                        <span class={styles.userGreeting}
                            >Hola, <span id="user-name">Usuario</span></span
                        >
                        <Icon
                            name="lucide:chevron-down"
                            class={styles.dropdownIcon}
                        />
                    </button>
                    <div class={`${styles.dropdownMenu} dropdown-menu`}>
                        <a href="/profile" class={styles.dropdownItem}>
                            <Icon name="lucide:user" class={styles.itemIcon} />
                            Mi Perfil
                        </a>
                        <a
                            href="/admin/dashboard"
                            class={`${styles.dropdownItem} admin-only`}
                            style="display: none;"
                        >
                            <Icon
                                name="lucide:layout-dashboard"
                                class={styles.itemIcon}
                            />
                            Panel Admin
                        </a>
                        <a
                            href="/orders"
                            class={`${styles.dropdownItem} customer-only`}
                        >
                            <Icon
                                name="lucide:shopping-bag"
                                class={styles.itemIcon}
                            />
                            Mis Compras
                        </a>
                        <div class={styles.dropdownDivider}></div>
                        <button
                            id="logout-btn"
                            class={`${styles.dropdownItem} ${styles.textRed}`}
                        >
                            <Icon
                                name="lucide:log-out"
                                class={styles.itemIcon}
                            />
                            Cerrar Sesión
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</nav>

<script>
    import { initNavbar } from "../scripts/navbar";

    // Initialize on load
    initNavbar();

    // Support for View Transitions
    document.addEventListener("astro:page-load", initNavbar);
</script>
