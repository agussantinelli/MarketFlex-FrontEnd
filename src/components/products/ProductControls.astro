---
import FilterButton from "./FilterButton.astro";
import SortSelect from "./SortSelect.astro";
import FilterModal from "./FilterModal.astro";
import styles from "./styles/controls.module.css";
import { filterService } from "../../services/filter.service";
import { getActivePromotions } from "../../services/promotion.service";
import { brandService } from "../../services/brand.service";

type Props = {
    sort: string;
    baseUrl: string;
    params?: URLSearchParams;
    showFilter?: boolean;
    showSort?: boolean;
    showOnlyOffersFilter?: boolean;
    fixedKeys?: string[];
    showPromotions?: boolean;
};

const {
    sort,
    baseUrl,
    params = new URLSearchParams(),
    showFilter = true,
    showSort = true,
    showOnlyOffersFilter = true,
    fixedKeys = [],
    showPromotions = false,
} = Astro.props;

// Fetch filter data for the modal
const categories = await filterService.getCategories();
const subcategories = await filterService.getSubcategories();
const brands = await brandService.getAll();
const promotions = showPromotions ? await getActivePromotions() : [];

const currentType = params.get("type") || undefined;
const currentCategory = params.get("category") || undefined;
const currentPromotion = params.get("promotion") || undefined;
const currentMinPrice = params.get("minPrice") || undefined;
const currentMaxPrice = params.get("maxPrice") || undefined;
---

<div class={styles.searchControls}>
    {showSort && <SortSelect sort={sort} baseUrl={baseUrl} params={params} />}

    {
        showFilter && (
            <>
                <FilterButton />
                <FilterModal
                    categories={categories}
                    subcategories={subcategories}
                    promotions={promotions}
                    brands={brands}
                    currentType={currentType}
                    currentCategory={currentCategory}
                    currentPromotion={currentPromotion}
                    currentBrands={
                        params.get("brand")?.split(",").filter(Boolean) || []
                    }
                    currentMinPrice={currentMinPrice}
                    currentMaxPrice={currentMaxPrice}
                    showOnlyOffersFilter={showOnlyOffersFilter}
                    fixedKeys={fixedKeys}
                />
            </>
        )
    }
</div>
