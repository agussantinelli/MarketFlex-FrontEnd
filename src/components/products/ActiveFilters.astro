---
import { Icon } from "astro-icon/components";
import styles from "./styles/ActiveFilters.module.css";

type Props = {
    baseUrl: string;
    params: URLSearchParams;
    fixedKeys?: string[];
};

const { baseUrl, params, fixedKeys = [] } = Astro.props;

type ActiveFilter = {
    label: string;
    key: string;
    url: string;
};

const activeFilters: ActiveFilter[] = [];

// Helper to create a URL without a specific filter
const getRemoveFilterUrl = (key: string) => {
    const newParams = new URLSearchParams(params);
    newParams.delete(key);
    // Always reset page to 1 when changing filters
    newParams.set("page", "1");
    return `${baseUrl}?${newParams.toString()}`;
};

// Process filters
const q = params.get("q");
if (q)
    activeFilters.push({
        label: `Búsqueda: ${q}`,
        key: "q",
        url: getRemoveFilterUrl("q"),
    });

const type = params.get("type");
if (type)
    activeFilters.push({
        label: `Categoría: ${type}`,
        key: "type",
        url: getRemoveFilterUrl("type"),
    });

const category = params.get("category");
if (category)
    activeFilters.push({
        label: `Subcategoría: ${category}`,
        key: "category",
        url: getRemoveFilterUrl("category"),
    });

const minPrice = params.get("minPrice");
if (minPrice)
    activeFilters.push({
        label: `Min: $${minPrice}`,
        key: "minPrice",
        url: getRemoveFilterUrl("minPrice"),
    });

const maxPrice = params.get("maxPrice");
if (maxPrice)
    activeFilters.push({
        label: `Max: $${maxPrice}`,
        key: "maxPrice",
        url: getRemoveFilterUrl("maxPrice"),
    });

const withStock = params.get("withStock");
if (withStock === "false")
    activeFilters.push({
        label: "Con y Sin Stock",
        key: "withStock",
        url: getRemoveFilterUrl("withStock"),
    });

const onlyOffers = params.get("onlyOffers");
if (onlyOffers === "true")
    activeFilters.push({
        label: "En Oferta",
        key: "onlyOffers",
        url: getRemoveFilterUrl("onlyOffers"),
    });

const promotion = params.get("promotion");
if (promotion)
    activeFilters.push({
        label: `Promo: ${promotion}`,
        key: "promotion",
        url: getRemoveFilterUrl("promotion"),
    });

const brands = params.get("brand")?.split(",").filter(Boolean) || [];
brands.forEach((brand) => {
    activeFilters.push({
        label: `Marca: ${brand}`,
        key: "brand",
        url: (() => {
            const newParams = new URLSearchParams(params);
            const remainingBrands = brands.filter((b) => b !== brand);
            if (remainingBrands.length > 0) {
                newParams.set("brand", remainingBrands.join(","));
            } else {
                newParams.delete("brand");
            }
            newParams.set("page", "1");
            return `${baseUrl}?${newParams.toString()}`;
        })(),
    });
});

if (activeFilters.length === 0) return null;
---

<div class={styles.activeFilters}>
    <div class={styles.chipsRow}>
        {
            activeFilters.map((filter) => (
                <div class={styles.filterChip}>
                    <span>{filter.label}</span>
                    {!fixedKeys.includes(filter.key) && (
                        <a
                            href={filter.url}
                            class={styles.removeFilter}
                            aria-label={`Quitar filtro ${filter.label}`}
                        >
                            <Icon name="lucide:x" size={12} />
                        </a>
                    )}
                </div>
            ))
        }
    </div>
    {
        activeFilters.length > 1 &&
            activeFilters.some((f) => !fixedKeys.includes(f.key)) && (
                <a
                    href={`${baseUrl}?${(() => {
                        const newParams = new URLSearchParams();
                        fixedKeys.forEach((key) => {
                            const val = params.get(key);
                            if (val) newParams.set(key, val);
                        });
                        // Keep search query if present
                        const q = params.get("q");
                        if (q) newParams.set("q", q);
                        newParams.set("page", "1");
                        return newParams.toString();
                    })()}`}
                    class={styles.clearAllFilters}
                >
                    <Icon name="lucide:rotate-ccw" size={12} />
                    Limpiar filtros
                </a>
            )
    }
</div>
