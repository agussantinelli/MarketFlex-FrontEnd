---
import { Icon } from "astro-icon/components";
import styles from "./styles/controls.module.css";
import type { Category } from "../../types/category.types";
import type { Subcategory } from "../../types/subcategory.types";

import type { Promotion } from "../../types/promotion.types";
import type { Brand } from "../../types/brand.types";

type Props = {
    categories: Category[];
    subcategories: Subcategory[];
    promotions: Promotion[];
    brands: Brand[];
    currentType?: string | undefined;
    currentCategory?: string | undefined;
    currentPromotion?: string | undefined;
    currentBrands?: string[] | undefined;
    currentMinPrice?: string | undefined;
    currentMaxPrice?: string | undefined;
    showOnlyOffersFilter?: boolean;
    fixedKeys?: string[];
};

const {
    categories,
    subcategories,
    promotions,
    brands,
    currentType,
    currentCategory,
    currentPromotion,
    currentBrands = [],
    currentMinPrice,
    currentMaxPrice,
    showOnlyOffersFilter = true,
    fixedKeys = [],
} = Astro.props;
---

<div
    id="filter-modal-backdrop"
    class={styles.modalBackdrop}
    data-categories={JSON.stringify(categories)}
    data-subcategories={JSON.stringify(subcategories)}
    data-promotions={JSON.stringify(promotions)}
    data-brands={JSON.stringify(brands)}
    data-styles={JSON.stringify(styles)}
    data-initial-type={currentType}
    data-initial-category={currentCategory}
    data-initial-promotion={currentPromotion}
    data-initial-brands={JSON.stringify(currentBrands)}
    data-fixed-keys={JSON.stringify(fixedKeys)}
>
    <div class={styles.modalContent}>
        <button id="close-modal-btn" class={styles.modalClose}>
            <Icon name="lucide:x" />
        </button>

        <div class={styles.modalScrollArea}>
            <div class={styles.modalHeader}>
                <div class={styles.modalIconWrapper}>
                    <Icon name="lucide:list-filter" class={styles.modalIcon} />
                </div>
                <h2 class={styles.modalTitle}>Filtrar Productos</h2>
            </div>

            <div class={styles.modalBody}>
                {/* Categorías */}
                {
                    !fixedKeys.includes("type") && (
                        <div class={styles.filterSection}>
                            <h3 class={styles.filterSectionTitle}>
                                Categorías
                            </h3>
                            <div class={styles.optionsGrid}>
                                {categories.map((cat) => (
                                    <button
                                        class:list={[
                                            styles.optionBtn,
                                            {
                                                [styles.optionActive as string]:
                                                    currentType === cat.nombre,
                                            },
                                        ]}
                                        data-type={cat.nombre}
                                        data-category-id={cat.id}
                                    >
                                        {cat.nombre}
                                    </button>
                                ))}
                            </div>
                        </div>
                    )
                }

                {/* Subcategorías - Conditional */}
                {
                    !fixedKeys.includes("category") && (
                        <div
                            id="subcategory-section"
                            class:list={[
                                styles.filterSection,
                                { [styles.hidden as string]: !currentType },
                            ]}
                        >
                            <h3 class={styles.filterSectionTitle}>
                                Subcategorías
                            </h3>
                            <div
                                id="subcategory-options"
                                class={styles.optionsGrid}
                            >
                                {subcategories
                                    .filter((sub) => {
                                        const parentCat = categories.find(
                                            (c) => c.nombre === currentType,
                                        );
                                        return (
                                            parentCat &&
                                            sub.categoriaId === parentCat.id
                                        );
                                    })
                                    .map((sub) => (
                                        <button
                                            class:list={[
                                                styles.optionBtn,
                                                {
                                                    [styles.optionActive as string]:
                                                        currentCategory ===
                                                        sub.nombre,
                                                },
                                            ]}
                                            data-category={sub.nombre}
                                        >
                                            {sub.nombre}
                                        </button>
                                    ))}
                            </div>
                        </div>
                    )
                }

                {/* Precio */}
                <div class={styles.filterSection}>
                    <h3 class={styles.filterSectionTitle}>Precio</h3>
                    <div class={styles.priceInputs}>
                        <div class={styles.inputGroup}>
                            <span>$</span>
                            <input
                                type="number"
                                id="min-price"
                                placeholder="Mínimo"
                                value={currentMinPrice}
                            />
                        </div>
                        <span class={styles.priceSeparator}>-</span>
                        <div class={styles.inputGroup}>
                            <span>$</span>
                            <input
                                type="number"
                                id="max-price"
                                placeholder="Máximo"
                                value={currentMaxPrice}
                            />
                        </div>
                    </div>
                </div>

                {/* Stock */}
                <div class={styles.filterSection}>
                    <div class={styles.checkboxSection}>
                        <label for="with-stock-checkbox"
                            >Solo productos con stock</label
                        >
                        <label class={styles.switch}>
                            <input type="checkbox" id="with-stock-checkbox" />
                            <span class={styles.slider}></span>
                        </label>
                    </div>
                </div>
                {
                    showOnlyOffersFilter && (
                        <div class={styles.filterSection}>
                            <div class={styles.checkboxSection}>
                                <label for="only-offers-checkbox">
                                    Solo productos en oferta
                                </label>
                                <label class={styles.switch}>
                                    <input
                                        type="checkbox"
                                        id="only-offers-checkbox"
                                    />
                                    <span class={styles.slider} />
                                </label>
                            </div>
                        </div>
                    )
                }
                {/* Promociones */}
                {
                    promotions.length > 0 && (
                        <div class={styles.filterSection}>
                            <h3 class={styles.filterSectionTitle}>
                                Promociones
                            </h3>
                            <div class={styles.optionsGrid}>
                                {promotions.map((promo) => (
                                    <button
                                        class:list={[
                                            styles.optionBtn,
                                            {
                                                [styles.optionActive as string]:
                                                    currentPromotion ===
                                                    promo.nombre,
                                            },
                                        ]}
                                        data-promotion={promo.nombre}
                                    >
                                        {promo.nombre}
                                    </button>
                                ))}
                            </div>
                        </div>
                    )
                }

                {/* Marcas (Editoriales) */}
                {
                    brands.length > 0 && (
                        <div class={styles.filterSection}>
                            <div
                                class={styles.collapsibleTrigger}
                                id="brands-trigger"
                            >
                                <h3 class={styles.filterSectionTitle}>
                                    Marcas
                                </h3>
                                <Icon
                                    name="lucide:chevron-down"
                                    class={styles.chevronIcon}
                                    id="brands-chevron"
                                />
                            </div>
                            <div
                                class:list={[
                                    styles.optionsGrid,
                                    styles.collapsed,
                                ]}
                                id="brands-content"
                            >
                                {brands.map((brand) => (
                                    <button
                                        class:list={[
                                            styles.optionBtn,
                                            {
                                                [styles.optionActive as string]:
                                                    currentBrands.includes(
                                                        brand.nombre,
                                                    ),
                                            },
                                        ]}
                                        data-brand={brand.nombre}
                                    >
                                        {brand.nombre}
                                    </button>
                                ))}
                            </div>
                        </div>
                    )
                }
            </div>

            <div class={styles.modalFooter}>
                <button id="reset-filters-btn" class={styles.resetBtn}
                    >Limpiar Filtros</button
                >
                <button id="apply-filters-btn" class={styles.applyBtn}
                    >Aplicar</button
                >
            </div>
        </div>
    </div>
</div>

<script src="../../scripts/filter-modal.ts"></script>
