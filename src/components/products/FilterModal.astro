---
import { Icon } from "astro-icon/components";
import styles from "./styles/controls.module.css";
import type { Category } from "../../types/category.types";
import type { Subcategory } from "../../types/subcategory.types";

interface Props {
    categories: Category[];
    subcategories: Subcategory[];
    currentType?: string;
    currentCategory?: string;
    currentMinPrice?: string;
    currentMaxPrice?: string;
}

const {
    categories,
    subcategories,
    currentType,
    currentCategory,
    currentMinPrice,
    currentMaxPrice,
} = Astro.props;
---

<div id="filter-modal-backdrop" class={styles.modalBackdrop}>
    <div class={styles.modalContent}>
        <button id="close-modal-btn" class={styles.modalClose}>
            <Icon name="lucide:x" />
        </button>

        <div class={styles.modalHeader}>
            <div class={styles.modalIconWrapper}>
                <Icon name="lucide:list-filter" class={styles.modalIcon} />
            </div>
            <h2 class={styles.modalTitle}>Filtrar Productos</h2>
        </div>

        <div class={styles.modalBody}>
            {/* Categorías */}
            <div class={styles.filterSection}>
                <h3 class={styles.filterSectionTitle}>Categorías</h3>
                <div class={styles.optionsGrid}>
                    {
                        categories.map((cat) => (
                            <button
                                class:list={[
                                    styles.optionBtn,
                                    {
                                        [styles.optionActive]:
                                            currentType === cat.nombre,
                                    },
                                ]}
                                data-type={cat.nombre}
                                data-category-id={cat.id}
                            >
                                {cat.nombre}
                            </button>
                        ))
                    }
                </div>
            </div>

            {/* Subcategorías - Conditional */}
            <div
                id="subcategory-section"
                class:list={[
                    styles.filterSection,
                    { [styles.hidden]: !currentType },
                ]}
            >
                <h3 class={styles.filterSectionTitle}>Subcategorías</h3>
                <div id="subcategory-options" class={styles.optionsGrid}>
                    {
                        /* Will be populated by JS or rendered if currentType exists */
                    }
                    {
                        subcategories
                            .filter((sub) => {
                                const parentCat = categories.find(
                                    (c) => c.nombre === currentType,
                                );
                                return (
                                    parentCat &&
                                    sub.categoriaId === parentCat.id
                                );
                            })
                            .map((sub) => (
                                <button
                                    class:list={[
                                        styles.optionBtn,
                                        {
                                            [styles.optionActive]:
                                                currentCategory === sub.nombre,
                                        },
                                    ]}
                                    data-category={sub.nombre}
                                >
                                    {sub.nombre}
                                </button>
                            ))
                    }
                </div>
            </div>

            {/* Precio */}
            <div class={styles.filterSection}>
                <h3 class={styles.filterSectionTitle}>Precio</h3>
                <div class={styles.priceInputs}>
                    <div class={styles.inputGroup}>
                        <span>$</span>
                        <input
                            type="number"
                            id="min-price"
                            placeholder="Mínimo"
                            value={currentMinPrice}
                        />
                    </div>
                    <span class={styles.priceSeparator}>-</span>
                    <div class={styles.inputGroup}>
                        <span>$</span>
                        <input
                            type="number"
                            id="max-price"
                            placeholder="Máximo"
                            value={currentMaxPrice}
                        />
                    </div>
                </div>
            </div>

            {/* Stock */}
            <div class={styles.filterSection}>
                <div class={styles.checkboxSection}>
                    <label for="with-stock-checkbox"
                        >Solo productos con stock</label
                    >
                    <label class={styles.switch}>
                        <input type="checkbox" id="with-stock-checkbox" />
                        <span class={styles.slider}></span>
                    </label>
                </div>
            </div>
        </div>

        <div class={styles.modalFooter}>
            <button id="reset-filters-btn" class={styles.resetBtn}
                >Limpiar Filtros</button
            >
            <button id="apply-filters-btn" class={styles.applyBtn}
                >Aplicar</button
            >
        </div>
    </div>
</div>

<script define:vars={{ subcategories, categories, styles }}>
    const backdrop = document.getElementById("filter-modal-backdrop");
    const closeBtn = document.getElementById("close-modal-btn");
    const filterBtn = document.getElementById("filter-btn");
    const applyBtn = document.getElementById("apply-filters-btn");
    const resetBtn = document.getElementById("reset-filters-btn");
    const subcategorySection = document.getElementById("subcategory-section");
    const subcategoryOptions = document.getElementById("subcategory-options");

    let selectedType = backdrop.getAttribute("data-initial-type") || "";
    let selectedCategory = backdrop.getAttribute("data-initial-category") || "";

    // Initialize selected states from URL or props
    const urlParams = new URLSearchParams(window.location.search);
    selectedType = urlParams.get("type") || "";
    selectedCategory = urlParams.get("category") || "";

    // Populate price inputs
    const minPriceInput = document.getElementById("min-price");
    const maxPriceInput = document.getElementById("max-price");
    const stockCheckbox = document.getElementById("with-stock-checkbox");

    if (minPriceInput) minPriceInput.value = urlParams.get("minPrice") || "";
    if (maxPriceInput) maxPriceInput.value = urlParams.get("maxPrice") || "";

    // Default to checked if not explicitly 'false'
    if (stockCheckbox) {
        stockCheckbox.checked = urlParams.get("withStock") !== "false";
    }

    function toggleModal() {
        backdrop.classList.toggle(styles.active);
    }

    if (filterBtn) filterBtn.addEventListener("click", toggleModal);
    if (closeBtn) closeBtn.addEventListener("click", toggleModal);
    backdrop.addEventListener("click", (e) => {
        if (e.target === backdrop) toggleModal();
    });

    // Category selection
    document
        .querySelectorAll(`.${styles.optionBtn}[data-type]`)
        .forEach((btn) => {
            btn.addEventListener("click", () => {
                const type = btn.getAttribute("data-type");
                const catId = btn.getAttribute("data-category-id");

                // Toggle selection
                if (selectedType === type) {
                    selectedType = "";
                    btn.classList.remove(styles.optionActive);
                } else {
                    // Clear others
                    document
                        .querySelectorAll(`.${styles.optionBtn}[data-type]`)
                        .forEach((b) =>
                            b.classList.remove(styles.optionActive),
                        );
                    selectedType = type;
                    btn.classList.add(styles.optionActive);
                }

                selectedCategory = ""; // Reset subcategory when type changes
                updateSubcategories(catId);
            });
        });

    function updateSubcategories(catId) {
        if (!selectedType || !catId) {
            subcategorySection.classList.add(styles.hidden);
            subcategoryOptions.innerHTML = "";
            return;
        }

        const filtered = subcategories.filter((s) => s.categoriaId === catId);

        if (filtered.length > 0) {
            subcategorySection.classList.remove(styles.hidden);
            subcategoryOptions.innerHTML = filtered
                .map(
                    (sub) => `
                <button 
                    class="${styles.optionBtn} ${selectedCategory === sub.nombre ? styles.optionActive : ""}"
                    data-category="${sub.nombre}"
                >
                    ${sub.nombre}
                </button>
            `,
                )
                .join("");

            // Add events to new buttons
            subcategoryOptions
                .querySelectorAll(`.${styles.optionBtn}`)
                .forEach((btn) => {
                    btn.addEventListener("click", () => {
                        const subName = btn.getAttribute("data-category");
                        if (selectedCategory === subName) {
                            selectedCategory = "";
                            btn.classList.remove(styles.optionActive);
                        } else {
                            subcategoryOptions
                                .querySelectorAll(`.${styles.optionBtn}`)
                                .forEach((b) =>
                                    b.classList.remove(styles.optionActive),
                                );
                            selectedCategory = subName;
                            btn.classList.add(styles.optionActive);
                        }
                    });
                });
        } else {
            subcategorySection.classList.add(styles.hidden);
        }
    }

    applyBtn.addEventListener("click", () => {
        const minPrice = document.getElementById("min-price").value;
        const maxPrice = document.getElementById("max-price").value;

        const params = new URLSearchParams(window.location.search);

        if (selectedType) params.set("type", selectedType);
        else params.delete("type");

        if (selectedCategory) params.set("category", selectedCategory);
        else params.delete("category");

        if (minPrice) params.set("minPrice", minPrice);
        else params.delete("minPrice");

        if (maxPrice) params.set("maxPrice", maxPrice);
        else params.delete("maxPrice");

        const stockCheckbox = document.getElementById("with-stock-checkbox");
        if (stockCheckbox && !stockCheckbox.checked) {
            params.set("withStock", "false");
        } else {
            params.delete("withStock"); // Default is true, so no need for explicit param if true
        }

        // Always reset to page 1 when filtering
        params.set("page", "1");

        window.location.href = `${window.location.pathname}?${params.toString()}`;
    });

    resetBtn.addEventListener("click", () => {
        const params = new URLSearchParams(window.location.search);
        params.delete("type");
        params.delete("category");
        params.delete("minPrice");
        params.delete("maxPrice");
        params.delete("withStock");
        params.set("page", "1");
        window.location.href = `${window.location.pathname}?${params.toString()}`;
    });
</script>
