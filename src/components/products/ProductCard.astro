---
import { Icon } from "astro-icon/components";
import type { Product } from "../../types/product.types";
import styles from "./styles/ProductCard.module.css";

interface Props {
    product: Product;
    showFeatured?: boolean;
    rank?: number;
}

const { product, showFeatured = true, rank } = Astro.props;
---

<article class={styles.productCard}>
    <div class={styles.imageContainer}>
        <img
            src={product.foto
                ? `http://localhost:5979/${product.foto}`
                : "/placeholder.png"}
            alt={product.nombre}
            class={styles.productImage}
            loading="lazy"
        />
        <div class={styles.priceTag}>${product.precioActual || "0.00"}</div>

        <div class={styles.badgesContainer}>
            {
                rank && (
                    <div
                        class={`${styles.rankBadge} ${
                            rank === 1
                                ? styles.rankGold
                                : rank === 2
                                  ? styles.rankSilver
                                  : rank === 3
                                    ? styles.rankBronze
                                    : styles.rankGeneric
                        }`}
                        title={`Puesto #${rank} en ventas`}
                    >
                        <span class={styles.rankNumber}>{rank}</span>
                    </div>
                )
            }
            {
                product.descuentoActivo && (
                    <div class={`${styles.badge} ${styles.discount}`}>
                        {product.descuentoActivo.porcentaje
                            ? `-${product.descuentoActivo.porcentaje}%`
                            : "OFERTA"}
                    </div>
                )
            }
            {
                product.esDestacado && showFeatured && (
                    <div
                        class={`${styles.badge} ${styles.featured}`}
                        title="Producto Destacado"
                    >
                        <Icon name="lucide:star" size={16} />
                    </div>
                )
            }
            {
                product.envioGratis && (
                    <div class={`${styles.badge} ${styles.freeShipping}`}>
                        <Icon name="lucide:truck" size={14} /> Envío Gratis
                    </div>
                )
            }
        </div>

        {
            product.stock === 0 && (
                <div class={styles.noStockOverlay}>
                    <span>Sin Stock</span>
                </div>
            )
        }

        <div class={styles.priceContainer}>
            {
                product.precioConDescuento ? (
                    <>
                        <span class={styles.originalPrice}>
                            ${product.precioActual}
                        </span>
                        <span
                            class={`${styles.currentPrice} ${styles.discountText}`}
                        >
                            ${product.precioConDescuento}
                        </span>
                    </>
                ) : (
                    <span class={styles.currentPrice}>
                        ${product.precioActual || "0.00"}
                    </span>
                )
            }
        </div>
    </div>
    <div class={styles.productInfo}>
        <div class={styles.productCategories}>
            {
                product.categoria && (
                    <span class={styles.categoryName}>{product.categoria}</span>
                )
            }
            {
                product.categoria && product.subcategoria && (
                    <span class={styles.separator}>•</span>
                )
            }
            {
                product.subcategoria && (
                    <span class={styles.categoryName}>
                        {product.subcategoria}
                    </span>
                )
            }
        </div>
        <h3 class={styles.title}>{product.nombre}</h3>
        <div class={styles.productMeta}>
            {
                product.marca && (
                    <span class={styles.brandEditorial}>{product.marca}</span>
                )
            }
            {
                product.autor && (
                    <span class={styles.authorLabel}>{product.autor}</span>
                )
            }
        </div>
        <p class={styles.description}>
            {
                product.caracteristicas
                    ? product.caracteristicas.substring(0, 100) +
                      (product.caracteristicas.length > 100 ? "..." : "")
                    : "Sin descripción disponible."
            }
        </p>
        <button class={styles.btnAdd} disabled={product.stock === 0}>
            <Icon name="lucide:shopping-cart" />
            {product.stock === 0 ? "Sin Stock" : "Agregar"}
        </button>
    </div>
</article>

<script>
    const addButtons = document.querySelectorAll("[class*='btnAdd']");

    addButtons.forEach((btn) => {
        btn.addEventListener("click", (e) => {
            const token = localStorage.getItem("marketflex_token");
            if (!token) {
                e.preventDefault();
                window.location.href = "/login";
                return;
            }

            // TODO: Implement Add to Cart logic here
            console.log("Add to cart clicked - User logged in");
            // trigger Sileo notification if available?
            if (window.triggerSileo) {
                window.triggerSileo("success", "Producto agregado (simulado)");
            } else {
                alert("Producto agregado (simulado)");
            }
        });
    });
</script>
