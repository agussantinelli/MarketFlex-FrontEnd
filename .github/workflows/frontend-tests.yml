name: Frontend CI (Tests)

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: marketflex_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout Frontend
        uses: actions/checkout@v4

      - name: Checkout Backend
        uses: actions/checkout@v4
        with:
          repository: agussantinelli/MarketFlex-BackEnd
          path: backend

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10

      - name: Setup Backend Environment
        working-directory: ./backend
        run: |
          echo "PORT=5979" >> .env
          echo "NODE_ENV=test" >> .env
          echo "DATABASE_URL=postgresql://postgres:password@localhost:5432/marketflex_test" >> .env
          echo "JWT_SECRET=super_secret_jwt_key_for_testing_purposes" >> .env
          echo "CLOUDINARY_CLOUD_NAME=mock" >> .env
          echo "CLOUDINARY_API_KEY=mock" >> .env
          echo "CLOUDINARY_API_SECRET=mock" >> .env
          echo "MAIL_HOST=mock" >> .env
          echo "MAIL_PORT=587" >> .env
          echo "MAIL_USER=mock@mock.com" >> .env
          echo "MAIL_PASS=mock" >> .env
          echo "MAIL_FROM=mock@mock.com" >> .env
          echo "RECAPTCHA_SITE_KEY=mock" >> .env
          echo "RECAPTCHA_SECRET_KEY=mock" >> .env
          echo "GOOGLE_CLIENT_ID=mock" >> .env
          echo "GOOGLE_CLIENT_SECRET=mock" >> .env
          echo "FACEBOOK_APP_ID=mock" >> .env
          echo "FACEBOOK_APP_SECRET=mock" >> .env

      - name: Install Backend Dependencies
        working-directory: ./backend
        run: pnpm install

      - name: Setup Database & Seed
        working-directory: ./backend
        run: |
          pnpm db:push
          pnpm db:seed

      - name: Start Backend Server
        working-directory: ./backend
        run: pnpm dev &
        
      - name: Wait for Backend to be Ready
        run: npx wait-on tcp:5979

      - name: Install Frontend Dependencies
        run: pnpm install

      - name: Install Playwright Browsers
        run: pnpm exec playwright install --with-deps

      - name: Run Unit & Component Tests
        run: pnpm test

      - name: Run E2E Tests
        run: pnpm test:e2e:ci
        env:
          PUBLIC_API_URL: http://localhost:5979/api
